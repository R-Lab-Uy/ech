---
title: "Estimación de ingresos"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{estimacion_ingresos}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
LOCAL <- identical(Sys.getenv("LOCAL"), "TRUE")
knitr::opts_chunk$set(purl = LOCAL)
```

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

La medición de los ingresos tiene un rezago de un mes ya que si el hogar fue encuestado, por ejemplo en marzo, en este mes se preguntó por los ingresos del mes pasado, es decir de febrero. A su vez, estos ingresos están expresados a precios corrientes, por lo cual, para hacerlos comparables entre los diferentes meses de la encuesta o de otros años es necesario llevarlos a una medida común. Para convertir de precios corrientes a precios constantes debemos elegir un índice como puede ser el IPC (Índice de Precios al Consumo) o el IPAB (Índice de Precios de Alimentos y Bebidas) para construir un deflactor. Por ejemplo, para expresar los ingresos del hogares con la información de la ECH 2019, elegimos como mes base junio y como año base 2019 y como deflactor el IPC. Esto implica que debemos considerar los valores del IPC mensual desde diciembre 2018 a noviembre 2019. 

Consumir los datos del IPC es bastante sencillo usando el paquete ech, de hecho la función para convertir ingresos corrientes a ingresos constantes, `income_constant_prices()` utiliza internamente la función que lee los datos del IPC desde la web del INE, `get_ipc()` y lo guarda en un formato tidy en el data frame ipc_base2010. La estructura del objeto es la siguiente:

```{r}
tail(ech::ipc_base2010)
```

Previamente tenemos que tener cargado el objeto con los microdatos de la ECH. Las variables a tener en cuenta en esta parte son 

- ht11: Ingreso total del hogar con valor locativo sin servicio doméstico 	ht11 	
- ht13: Valor locativo 	ht13 	
- ht19: Cantidad de personas sin servicio doméstico 

```{r eval = FALSE}
library(ech)
df <- get_microdata(year = 2019)
```

Para convertir los ingresos del hogar, que están medidos en la variable ht11, de precios corrientes a precios constantes, usamos la función `income_constant_prices()` y definimos sus parámetros: mes base, año base y el tipo de ipc que puede ser "G" para todo el país sin distinción de regiones o "R" que usa el IPC de Montevideo y el del Interior.

```{r eval = FALSE}
df <- income_constant_prices(df, base_month = , base_year = , ipc = "G")
```

Esto crea una serie de variables:

- y_pc: ingreso per cápita a precios corrientes
- y_pc_d: ingreso per cápita a precios constantes
- rv_d: valor locativo a precios constantes
- y_wrv_d: ingreso sin valor locativo a precios constantes
- y_wrv_pc_d: ingreso sin valor locativo per cápita a precios constantes

Para obtener la estimación de alguna de estas variables usamos la función `get_estimation_mean()`, para estimar la media, o `get_estimation_total()`, para estimar el total. Estas funciones tienen algunos argumentos que refieren al diseño de muestreo como: 

- ids: se debe indicar la variable que identifica a la unidades primarias de muestreo. Para los microdatos de 2018 y 2019 la ECH pública cuenta con la información de las UPM y en la web del INE se encuentra en un archivo aparte pero la función get_microdata ya la agrega a los microdatos de manera que no es necesario hacer un merge entre ambas bases. Para años anteriores no están disponible estás variables en la base pública.
- estrato: se debe indicar la variable que identifica a los estratos.
- numero: se debe indicar la variable que identifica a los hogares
- pesoano: se debe indicar la variable uqe identifica los pesos asociados a cada hogar.

Es necesario definir ids y estrato que vienen con valor por defecto NULL, las demás no es necesario definir porque ya vienen con el nombre de la variable por defecto, salvo que se usen registros de un mes o semestre en ese caso se debe cambiar el ponderador de los casos según corresponda.

```{r eval = FALSE}
get_estimation_mean(df, variable = "y_pc_d", level = "i", ids = "upm_fic")
```


Para estimar el ingreso medio de los hogares a precios constantes de junio 2019 según decil, se debe definir en el argumento by.x la variable decil, previamente calculada con `income_quantile()`.

```{r eval = FALSE}
df <- income_quantiles(df, income = "y_pc_d", quantile = 10)
# Estimación de ingresos promedio per cápita a pesos constantes de jun/19 según decil
get_estimation_mean(df, variable = "y_pc_d", by.x = "decil", level = "i")
```

Una forma de mostrar estos resultados es mediante un gráfico como el siguiente:


